# Cursor Rules for QueryCanvas - Database Client

## Project Overview
QueryCanvas is a database client extension for VS Code/Cursor with AI-powered features.

---

## âš ï¸ MOST IMPORTANT: SQL Display Options Syntax

When generating SQL with display options, follow these rules EXACTLY:

### @column directive (cell styling)
```sql
@column <name> type=int if<0:color=red
```
- Use `if<operator><value>:style` for conditions
- Example: `@column å£²ä¸Š type=int if<0:color=red if>1000000:color=green`

### @row directive (entire row styling)
```sql
@row <column_name><operator><value>:<styles>
```
- **NO `if` keyword!**
- Use `==` (double equals) for equality
- Quote strings: `"value"` or `'value'`
- Use `bg` NOT `background`
- Example: `@row æ›œæ—¥=="åœŸ":bg=#eeeeff`
- Example: `@row å£²ä¸Š>1000000:bg=#ccffcc,bold=true`

### âŒ WRONG Examples
```sql
@row if æ›œæ—¥=åœŸ:background=#eee     âŒ NO! Has 'if', uses '=', uses 'background'
@row å›½å=ãƒ•ãƒ©ãƒ³ã‚¹:bg=#fee           âŒ NO! No quotes, uses single '='
```

### âœ… CORRECT Examples
```sql
@row æ›œæ—¥=="åœŸ":bg=#eee              âœ… YES!
@row å›½å=="ãƒ•ãƒ©ãƒ³ã‚¹":bg=#fee        âœ… YES!
@row å£²ä¸Š>1000000:bg=#ccffcc         âœ… YES!
```

---

## ğŸ¨ SQL Display Options - Quick Reference

### Two Types of Styling

#### 1. Column Styling (`@column`) - Styles individual cells
```sql
/**
 * @column å£²ä¸Š type=int align=right format=number comma=true if<0:color=red
 */
```
- Uses `if<value:style` syntax for conditional styling
- Applies to individual cells in that column

#### 2. Row Styling (`@row`) - Styles entire rows
```sql
/**
 * @row æ›œæ—¥=="åœŸ":bg=#eeeeff
 * @row å£²ä¸Š>1000000:bg=#ccffcc,bold=true
 */
```
- **CRITICAL:** Do NOT use `if` keyword
- Use `==` (double equals) for equality, NOT `=` (single)
- Strings MUST be quoted: `"å€¤"` or `'å€¤'`
- Use `bg` or `backgroundColor`, NOT `background`
- Applies styling to the entire row

### Common Mistakes âš ï¸

| âŒ WRONG | âœ… CORRECT |
|----------|-----------|
| `@row if æ›œæ—¥=åœŸ:background=#eee` | `@row æ›œæ—¥=="åœŸ":bg=#eee` |
| `@row å›½å=ãƒ•ãƒ©ãƒ³ã‚¹:bg=#fee` | `@row å›½å=="ãƒ•ãƒ©ãƒ³ã‚¹":bg=#fee` |
| `@row å£²ä¸Š>1000:background=#cfc` | `@row å£²ä¸Š>1000:bg=#cfc` |

### Syntax Comparison

| Feature | Column Style | Row Style |
|---------|-------------|-----------|
| Directive | `@column` | `@row` |
| Conditional | `if<0:color=red` | `å£²ä¸Š<0:bg=#fcc` |
| `if` keyword | âœ… YES (use `if`) | âŒ NO (`if` not used) |
| Equality | `==` or single `=` | `==` (double only) |
| String values | No quotes needed in options | MUST quote: `"value"` |
| Example | `@column æç›Š type=int if<0:color=red` | `@row æ›œæ—¥=="åœŸ":bg=#eef` |

---
## ğŸ¤– Cursor AI Integration

This extension is designed to work seamlessly with Cursor AI. You can edit SQL queries by modifying the session file.

### SQL Session File

**Location:** `.vscode/querycanvas-session.json`

**What it contains:**
- Current SQL query in the editor
- Active database connection ID
- Last update timestamp

**How Cursor AI can help:**

1. **Edit SQL directly in session file:**
   - User can ask: "Modify the SQL in the session to add a WHERE clause"
   - Cursor AI edits `.vscode/querycanvas-session.json`
   - Changes reflect in Database Client UI immediately (via file watcher)

2. **Generate optimized SQL:**
   - User can ask: "Rewrite this SQL with display options"
   - Cursor AI updates the `sqlInput` field with formatted SQL

3. **Add display options:**
   - User can ask: "Add display formatting to this query"
   - Cursor AI inserts `/** @column ... */` comments

**Example session file:**
```json
{
  "connectionId": "production-db",
  "isConnected": false,
  "sqlInput": "/**\n * @column amount align=right format=number comma=true\n */\nSELECT amount FROM orders",
  "lastUpdated": "2025-12-28T12:00:00.000Z"
}
```

**Workflow:**
```
User: "Add display options to format the 'price' column"
  â†“
Cursor AI: Edits .vscode/querycanvas-session.json
  â†“
File watcher: Detects change
  â†“
UI: Updates automatically
  â†“
User: Sees formatted SQL in Database Client
```

## SQL Display Options Feature

This extension supports custom display formatting through SQL comments.

### Syntax
Use `/** ... */` comments at the beginning or end of SQL queries with `@column` and `@row` directives:

```sql
/**
 * @column <column_name> <option>=<value> <option>=<value> ...
 * @row <column_name><operator><value>:<styles>
 */
SELECT ...
```

### Supported Options

#### Text Alignment
- `align=left|center|right` - Text alignment in table cells

#### Number Formatting
- `format=number` - Format as number
- `comma=true|false` - Add thousands separator (1,234,567)
- `decimal=N` - Number of decimal places (e.g., decimal=2 â†’ 123.45)

#### Datetime Formatting
- `format=datetime` - Format as datetime
- `pattern=<format>` - Date format pattern
  - `yyyy` = 4-digit year
  - `MM` = 2-digit month
  - `dd` = 2-digit day
  - `HH` = 2-digit hour (24h)
  - `mm` = 2-digit minute
  - `ss` = 2-digit second
  - Example: `pattern=yyyy/MM/dd_HH:mm:ss`
  - **Note:** Use double quotes if pattern contains spaces: `pattern="yyyy-MM-dd HH:mm:ss"`

#### Column Styling
- `width=<size>` - Column width (e.g., `width=200px`)
- `color=<color>` - Text color (e.g., `color=#ff0000`)
- `bg=<color>` or `backgroundColor=<color>` - Background color
- `bold=true` - Make text bold

#### Data Type & Conditional Styling ğŸ†•
- `type=int|float|decimal|text` - Specify column data type
- `if<æ¼”ç®—å­><å€¤>:<ã‚¹ã‚¿ã‚¤ãƒ«>` - Conditional styling based on cell value (within @column directive)
  - Operators: `<`, `>`, `<=`, `>=`, `==`, `!=`
  - Styles: `color=<color>`, `bg=<color>`, `bold=true`, `fontWeight=<value>`
  - Example: `if<0:color=red` (negative values in red)
  - Example: `if>1000:bold=true` (values over 1000 in bold)
  - Example: `if<=0:color=#999999 if>=10000:color=#ff0000,bold=true` (multiple conditions)
  - **Note:** This `if` syntax is ONLY for @column directives, NOT for @row directives

#### Row Styling ğŸ†•
- `@row <column_name><operator><value>:<styles>` - Style entire rows based on column values
  - **IMPORTANT:** Do NOT use `if` keyword. Use direct comparison: `@row åˆ—å==å€¤` (NOT `@row if åˆ—å=å€¤`)
  - Operators: `<`, `>`, `<=`, `>=`, `==`, `!=` (use `==` for equality, NOT single `=`)
  - Values: Numbers (e.g., `1000`) or strings with quotes (e.g., `"ãƒ•ãƒ©ãƒ³ã‚¹"`, `'completed'`)
  - Styles: `color=<color>`, `bg=<color>` or `backgroundColor=<color>`, `bold=true`, `fontWeight=<value>`
  - Example: `@row å›½å=="ãƒ•ãƒ©ãƒ³ã‚¹":color=#ff0000,bg=#ffeeee` (rows with country="ãƒ•ãƒ©ãƒ³ã‚¹" in red)
  - Example: `@row å£²ä¸Š>1000000:bg=#ccffcc,bold=true` (rows with sales>1M in green)
  - Example: `@row ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹=="å®Œäº†":bg=#d4edda,color=#155724` (completed rows in green)
  - **Common mistakes to avoid:**
    - âŒ `@row if æ›œæ—¥=åœŸ:background=#eeeeff` (WRONG: has `if` keyword, uses `=` instead of `==`, uses `background` instead of `bg`)
    - âœ… `@row æ›œæ—¥=="åœŸ":bg=#eeeeff` (CORRECT: no `if`, uses `==`, uses `bg`)

### Examples

#### Financial Report
```sql
/**
 * @column åº—èˆ—å width=150px
 * @column å£²ä¸Š align=right format=number comma=true
 * @column å‰å¹´æ¯” align=right format=number decimal=1
 * @column æ›´æ–°æ—¥æ™‚ format=datetime pattern=yyyy/MM/dd_HH:mm
 */
SELECT åº—èˆ—å, å£²ä¸Š, å‰å¹´æ¯”, æ›´æ–°æ—¥æ™‚ FROM sales_report;
```

#### Styled Table
```sql
/**
 * @column ID align=right
 * @column ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ color=#00ff00 bold=true
 * @column é‡‘é¡ align=right format=number comma=true decimal=2
 * @column ä½œæˆæ—¥æ™‚ format=datetime pattern=yyyy/MM/dd
 */
SELECT ID, ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹, é‡‘é¡, ä½œæˆæ—¥æ™‚ FROM orders;
```

#### Conditional Styling Example ğŸ†•
```sql
/**
 * @column å£²ä¸Š type=int align=right format=number comma=true if<0:color=red,bold=true if>1000000:color=blue,bold=true
 * @column åœ¨åº«æ•° type=int align=right if<=0:color=red,bold=true if<=10:color=orange if>100:color=green
 * @column é”æˆç‡ type=float align=right format=number decimal=1 if<80:color=red if>=100:color=green,bold=true
 */
SELECT å£²ä¸Š, åœ¨åº«æ•°, é”æˆç‡ FROM performance_data;
```

#### Row Styling Example ğŸ†•
```sql
/**
 * @row å›½å=="ãƒ•ãƒ©ãƒ³ã‚¹":color=#ff0000,bg=#ffeeee
 * @row å›½å=="æ—¥æœ¬":color=#0000ff,bg=#eeeeff
 * @row å£²ä¸Š>1000000:bg=#ccffcc,bold=true
 * @column å£²ä¸Š align=right format=number comma=true
 */
SELECT å›½å, éƒ½å¸‚, å£²ä¸Š, æ‹…å½“è€… FROM sales_data;
```

#### Row + Column Styling Combined ğŸ†•
```sql
/**
 * @row é”æˆç‡>=100:bg=#e8f5e9
 * @row é”æˆç‡<80:bg=#ffebee
 * @column å£²ä¸Š type=int align=right format=number comma=true if<0:color=red
 * @column é”æˆç‡ type=float align=right format=number decimal=1 if<80:color=red if>=100:color=green,bold=true
 */
SELECT åº—èˆ—å, å£²ä¸Š, é”æˆç‡, å‰å¹´æ¯” FROM performance_dashboard;
```

### Implementation Details
- Parser: `src/sqlCommentParser.ts`
- Options are extracted in `DatabaseClientPanel._handleExecuteQuery()`
- Formatting applied in Webview's `handleQueryResult()` function
- Number formatting uses `formatValue()` helper
- Datetime formatting uses `formatDateTime()` helper
- Column styling uses `generateColumnStyle()` helper (for headers)
- Conditional styling uses `generateConditionalStyle()` helper (for cells, evaluates conditions based on cell values)
- Row styling uses `generateRowStyle()` helper (for rows, evaluates conditions based on row data) ğŸ†•

## Coding Guidelines

### TypeScript
- Use strict typing
- Prefer interfaces over types for extensibility
- Document public APIs with JSDoc comments

### SQL Validation
- Only read-only queries allowed (SELECT, SHOW, DESC, EXPLAIN)
- INSERT, UPDATE, DELETE are blocked by `SqlValidator`

### Session Persistence
- SQL input auto-saved to `.vscode/db-client-session.json`
- File watcher syncs external changes (Cursor edits)
- Query results auto-saved to `query-results/` directory

### Internationalization
- English is default language
- Japanese is supported
- Translation files: `src/i18n/en.json`, `src/i18n/ja.json`
- Schema documents adapt to VS Code language setting

## File Structure
- `src/databaseClientPanel.ts` - Main Webview panel
- `src/database/` - Database connection layer
- `src/i18n/` - Translation files
- `src/sqlCommentParser.ts` - Display options parser
- `src/sqlFormatter.ts` - SQL beautifier
- `src/sqlValidator.ts` - SQL security validator

## ğŸ“‹ Clipboard Copy to PowerPoint/Excel/Word Feature ğŸ†•

After executing a query, users can copy results to clipboard in two formats:

### TSV Copy (Tab-Separated Values)
- **Button:** "ğŸ“‹ TSVã‚³ãƒ”ãƒ¼"
- **Format:** Plain text with tab separators
- **Use case:** Simple data transfer to any application
- **Preserves:** Data only (no styling)
- **Compatible with:** PowerPoint, Excel, Word, Google Sheets, etc.

### HTML Copy (Rich Format)
- **Button:** "ğŸ“‹ HTMLã‚³ãƒ”ãƒ¼"
- **Format:** HTML table with inline styles
- **Use case:** Rich presentations and reports
- **Preserves:** 
  - Colors, bold, and other text styles
  - Conditional styling (red negatives, green positives, etc.)
  - Number formatting (commas, decimal places)
  - Alignment and column widths
- **Compatible with:** PowerPoint, Excel, Word, Outlook

### When to Recommend

**Recommend HTML Copy when:**
- User needs styled tables for presentations
- Query uses conditional styling (`if<0:color=red`)
- Query uses number/datetime formatting
- User mentions PowerPoint, Excel, or creating reports

**Recommend TSV Copy when:**
- User needs simple data transfer
- Compatibility is a concern
- No styling is needed

### Example Workflow for Presentations

```sql
/**
 * @column å£²ä¸Š type=int align=right format=number comma=true if<0:color=red if>2000000:color=green,bold=true
 * @column é”æˆç‡ type=float align=right format=number decimal=1 if<80:color=red if>=100:color=green,bold=true
 * @column æ›´æ–°æ—¥æ™‚ format=datetime pattern=yyyy/MM/dd
 */
SELECT åº—èˆ—å, å£²ä¸Š, é”æˆç‡, æ›´æ–°æ—¥æ™‚
FROM sales_dashboard
ORDER BY å£²ä¸Š DESC
LIMIT 10;
```

â†’ Execute â†’ Click "ğŸ“‹ HTMLã‚³ãƒ”ãƒ¼" â†’ Paste in PowerPoint â†’ Beautiful styled table!

### User Prompts You Might See

- "PowerPointã«è²¼ã‚Šä»˜ã‘ã‚‰ã‚Œã‚‹å½¢å¼ã§ã‚³ãƒ”ãƒ¼ã—ãŸã„"
  â†’ Suggest HTML Copy for styled output
  
- "ã“ã®ã‚¯ã‚¨ãƒªçµæœã‚’Excelã§ä½¿ã„ãŸã„"
  â†’ Suggest TSV Copy for data, HTML Copy for styled reports
  
- "ãƒ—ãƒ¬ã‚¼ãƒ³è³‡æ–™ã‚’ä½œã‚ŠãŸã„"
  â†’ Suggest adding display options + conditional styling + HTML Copy
  
- "è³‡æ–™ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã„"
  â†’ Ask if styling is needed, then recommend HTML or TSV Copy

### Implementation Details
- TSV copy: `copyTableAsTSV()` function in `databaseClientPanel.ts`
- HTML copy: `copyTableAsHTML()` function in `databaseClientPanel.ts`
- Buttons appear automatically after query execution
- Uses Clipboard API: `navigator.clipboard.write()` for HTML, `writeText()` for TSV

### Documentation
- User guide: `docs/POWERPOINT-COPY-GUIDE.md`
- Testing guide: `docs/TESTING-POWERPOINT-COPY.md`

## When Helping with SQL Queries

1. Always suggest using display options for better presentation
2. Use `align=right` for numeric columns
3. Use `format=number comma=true` for currency/large numbers
4. Use `format=datetime pattern=...` for timestamps
5. Use conditional styling for highlighting important values (e.g., `if<0:color=red` for negative numbers)
6. Specify `type=int|float|decimal` when using conditional styling
7. **ğŸ†• Use row styling (`@row`) to highlight entire rows based on conditions**
8. **ğŸ†• Combine row and column styling for sophisticated visual presentations**
9. Keep column names in original language (often Japanese)
10. Remember this is a read-only client (no INSERT/UPDATE/DELETE)
11. **Mention clipboard copy feature when user needs to create reports or presentations**
12. **Suggest HTML Copy to preserve styling in PowerPoint/Excel**

## âš ï¸ CRITICAL: Row Styling Syntax

**When user asks about row styling or @row directives, ALWAYS use this syntax:**

```sql
@row <column_name><operator><value>:<styles>
```

**Rules:**
- âŒ Do NOT use `if` keyword
- âœ… Use `==` (double equals) for equality
- âœ… Quote string values: `"åœŸ"`, `'å®Œäº†'`
- âœ… Use `bg` or `backgroundColor` (NOT `background`)

**Examples:**
```sql
@row æ›œæ—¥=="åœŸ":bg=#eeeeff
@row å£²ä¸Š>1000000:bg=#ccffcc,bold=true
@row ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹=="å®Œäº†":bg=#d4edda,color=#155724
```

**NOT:**
```sql
@row if æ›œæ—¥=åœŸ:background=#eeeeff  âŒ WRONG!
```

