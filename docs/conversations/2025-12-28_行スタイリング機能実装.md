# 行スタイリング機能実装

**日付**: 2025年12月28日  
**ブランチ**: `feature/row-styling`  
**実装者**: Cursor AI

## 概要

特定の列の値に基づいて**行全体**にスタイルを適用する機能を実装しました。これにより、データをより視覚的に分かりやすく表示できます。

## 実装内容

### 1. SQLコメントパーサーの拡張 (`src/sqlCommentParser.ts`)

#### 新しい型定義

```typescript
/** 行スタイルルール */
export interface RowStyleRule {
    /** 対象列名 */
    columnName: string;
    /** 条件演算子 (<, >, <=, >=, ==, !=) */
    operator: '<' | '>' | '<=' | '>=' | '==' | '!=';
    /** 比較値（数値または文字列） */
    value: number | string;
    /** 適用するスタイル */
    styles: {
        color?: string;
        backgroundColor?: string;
        bold?: boolean;
        fontWeight?: string;
    };
}
```

#### `QueryDisplayOptions`の拡張

```typescript
export interface QueryDisplayOptions {
    columns: Map<string, ColumnDisplayOptions>;
    rowStyles?: RowStyleRule[];  // 🆕 追加
}
```

#### `parseOptions()`メソッドの更新

- `@row`ディレクティブの抽出と解析を追加
- 行スタイルルールを`rowStyles`配列に格納

#### 新規メソッド: `parseRowDirective()`

`@row`ディレクティブをパースして`RowStyleRule`オブジェクトを生成：

- 文字列値（クォート付き）と数値の両方に対応
- 正規表現で列名、演算子、値、スタイルを抽出
- スタイル文字列をパースして`styles`オブジェクトを生成

#### 新規メソッド: `generateRowStyle()`

行データに基づいて行スタイルを生成：

- 各ルールを評価
- 数値比較と文字列比較の両方をサポート
- 条件が真の場合、スタイルを適用

### 2. Webviewの更新 (`src/databaseClientPanel.ts`)

#### サーバー側の変更

`_handleExecuteQuery()`メソッドで、Webviewに`rowStyleRules`を送信：

```typescript
this.sendMessage({
    type: 'queryResult',
    success: true,
    columns: result.columns,
    rows: result.rows,
    rowCount: result.rowCount,
    executionTime: result.executionTime,
    displayOptions: Array.from(displayOptions.columns.entries()).map(([_, opts]) => opts),
    rowStyleRules: displayOptions.rowStyles || []  // 🆕 追加
});
```

#### クライアント側（Webview）の変更

##### `generateRowStyle()`関数の追加

行データとルール配列を受け取り、CSSスタイル文字列を生成：

- 数値比較と文字列比較の両方に対応
- 複数のルールが一致した場合は、すべてのスタイルを適用

##### `handleQueryResult()`関数の更新

- `rowStyleRules`を保存
- テーブル生成時に各行に`generateRowStyle()`を適用
- `<tr style="...">`タグにスタイルを追加

##### `copyTableAsHTML()`関数の更新

HTMLコピー機能で行スタイルもコピーされるように対応：

- `rowStyleRules`を取得
- 各行に`generateRowStyle()`を適用
- PowerPoint/Excel/Wordへの貼り付けで行スタイルが保持される

### 3. ドキュメントの作成・更新

#### 新規作成

- `docs/ROW-STYLING-GUIDE.md` - 行スタイリング機能の完全ガイド
- `docs/examples/row-styling-examples.sql` - 10種類の実用的なサンプルSQL

#### 更新

- `DISPLAY-OPTIONS-QUICK-GUIDE.md` - 行スタイリングのセクションを追加
- `.cursorrules` - 行スタイリング機能の説明と例を追加

## 構文

```sql
/**
 * @row <列名><演算子><値>:<スタイル>
 */
SELECT ...
```

### パラメータ

- **列名**: 条件を評価する対象の列
- **演算子**: `<`, `>`, `<=`, `>=`, `==`, `!=`
- **値**: 
  - 数値: そのまま記述（例: `1000`, `-50`）
  - 文字列: クォートで囲む（例: `"フランス"`, `'completed'`）
- **スタイル**: カンマ区切りで複数指定可能
  - `color=<色>` - 文字色
  - `bg=<色>` - 背景色
  - `bold=true` - 太字
  - `fontWeight=<値>` - フォントウェイト

## 使用例

### 例1: 文字列値に基づく行スタイリング

```sql
/**
 * @row 国名=="フランス":color=#ff0000,bg=#ffeeee
 * @row 国名=="日本":color=#0000ff,bg=#eeeeff
 * @column 売上 align=right format=number comma=true
 */
SELECT 国名, 都市, 売上, 担当者 FROM sales_data;
```

### 例2: 数値に基づく行スタイリング

```sql
/**
 * @row 売上>1000000:bg=#ccffcc,bold=true
 * @row 売上<0:bg=#ffcccc,color=#ff0000
 * @column 売上 align=right format=number comma=true
 */
SELECT 店舗名, 売上, 前年比, 地域 FROM store_performance;
```

### 例3: ステータスに基づく行スタイリング

```sql
/**
 * @row ステータス=="完了":bg=#d4edda,color=#155724
 * @row ステータス=="保留":bg=#fff3cd,color=#856404
 * @row ステータス=="キャンセル":bg=#f8d7da,color=#721c24
 * @column 金額 align=right format=number comma=true
 */
SELECT 注文ID, ステータス, 金額, 顧客名 FROM orders;
```

### 例4: 行スタイルと列スタイルの組み合わせ

```sql
/**
 * @row 達成率>=100:bg=#e8f5e9
 * @row 達成率<80:bg=#ffebee
 * @column 売上 type=int align=right format=number comma=true if<0:color=red
 * @column 達成率 type=float align=right format=number decimal=1 if<80:color=red if>=100:color=green,bold=true
 */
SELECT 店舗名, 売上, 達成率, 前年比 FROM performance_dashboard;
```

## 技術的な詳細

### パース処理

`parseRowDirective()`メソッドの正規表現：

```typescript
const match = directive.match(/@row\s+(\S+?)([<>!=]+)("([^"]*)"|'([^']*)'|(-?\d+(?:\.\d+)?)):(.+)/);
```

- グループ1: 列名
- グループ2: 演算子
- グループ4/5: クォート付き文字列（ダブル/シングル）
- グループ6: 数値
- グループ7: スタイル文字列

### 条件評価のロジック

#### 数値比較

```typescript
if (typeof rule.value === 'number') {
    const numValue = typeof cellValue === 'number' ? cellValue : parseFloat(String(cellValue));
    // 演算子に応じて比較
}
```

#### 文字列比較

```typescript
else {
    const strValue = String(cellValue);
    const compareStr = String(rule.value);
    // 演算子に応じて比較（==, !=, <, >, <=, >=）
}
```

### スタイル優先順位

1. 複数のルールがマッチした場合、**すべて適用**される
2. 行スタイルと列スタイルが競合する場合、**列スタイルが優先**される（セルレベル > 行レベル）

## テスト方法

### 1. 基本的な行スタイリング

```sql
/**
 * @row 国名=="日本":bg=#eeeeff
 */
SELECT * FROM countries;
```

日本の行が薄い青色の背景で表示されることを確認。

### 2. 数値条件

```sql
/**
 * @row 売上>1000000:bg=#ccffcc,bold=true
 */
SELECT * FROM sales;
```

売上が1,000,000を超える行が緑色で太字になることを確認。

### 3. 複数条件

```sql
/**
 * @row ステータス=="完了":bg=#d4edda
 * @row ステータス=="保留":bg=#fff3cd
 */
SELECT * FROM orders;
```

ステータスに応じて異なる色が適用されることを確認。

### 4. HTMLコピー

1. 上記のクエリを実行
2. **📋 HTMLコピー**ボタンをクリック
3. PowerPointに貼り付け
4. 行スタイルが保持されていることを確認

## パフォーマンス考慮事項

- 行ごとにすべてのルールを評価するため、大量のデータ（1000行以上）では若干のパフォーマンス影響がある可能性
- ただし、評価は単純な比較演算のみなので、実用上は問題ない

## 今後の拡張可能性

1. **正規表現マッチング**: `@row 商品名~="^[A-Z]":bg=...`
2. **NULL値の扱い**: `@row 在庫数==null:bg=gray`
3. **複数列の組み合わせ条件**: `@row 売上>1000000 AND 達成率>=100:bg=gold`
4. **行番号による条件**: `@row rownum%2==0:bg=#f0f0f0`（偶数行）

## 関連ファイル

- `src/sqlCommentParser.ts` - パーサー本体
- `src/databaseClientPanel.ts` - Webviewパネル
- `docs/ROW-STYLING-GUIDE.md` - ユーザーガイド
- `docs/examples/row-styling-examples.sql` - サンプル集
- `DISPLAY-OPTIONS-QUICK-GUIDE.md` - クイックリファレンス
- `.cursorrules` - Cursor AI向けルール

## 変更履歴

- 2025-12-28: 初回実装完了
  - パーサー拡張
  - Webview更新
  - ドキュメント作成
  - コンパイル成功確認

