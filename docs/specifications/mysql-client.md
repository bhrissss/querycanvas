# Cursor連携型 データベースクライアント機能

## 概要

VS Code/Cursor内でMySQL/PostgreSQLデータベースに接続し、SQLクエリを実行して結果を表示する機能。
**Cursorとの連携を前提**とし、テーブル定義のドキュメント化と、クエリ結果の保存・分析を支援する。

## 対応データベース

- ✅ **MySQL** (5.7+, 8.0+)
- ✅ **PostgreSQL** (12+, 13+, 14+, 15+, 16+)

## 目的

- エディタを離れずにデータベース操作を行える
- **複数のデータベース接続を管理**（開発・ステージング・本番など）
- **テーブル定義を自動取得し、Cursorと会話しながらドキュメント化**
- **クエリ結果をTSV/JSON形式で保存し、分析に活用**
- データベーススキーマをプロジェクトの一部として管理
- データ分析のためのスナップショット管理

## UI設計

### レイアウト

```
┌─────────────────────────────────────────┐
│ 接続: [開発DB ▼] 状態: ●接続中           │
│ [⚙️ 接続管理] [📋 テーブル定義] [📁 データ] │
├─────────────────────────────────────────┤
│ SQL入力エリア                            │
│ SELECT * FROM users;                    │
│                                         │
│ [実行 ▶]  [クリア]  [💾 結果を保存]     │
├─────────────────────────────────────────┤
│ 結果テーブル                             │
│ ┌────┬────────┬─────────┐              │
│ │ id │ name   │ email   │              │
│ ├────┼────────┼─────────┤              │
│ │ 1  │ Alice  │ a@ex.com│              │
│ │ 2  │ Bob    │ b@ex.com│              │
│ └────┴────────┴─────────┘              │
│                                         │
│ 実行時間: 0.123秒 | 行数: 2             │
└─────────────────────────────────────────┘

【接続管理ダイアログ】
┌─────────────────────────────────────────┐
│ データベース接続管理                     │
├─────────────────────────────────────────┤
│ 保存済み接続:                            │
│ ● 開発DB (MySQL)      [編集] [削除]     │
│ ● 本番DB (PostgreSQL) [編集] [削除]     │
│                                         │
│ [+ 新しい接続を追加]                     │
└─────────────────────────────────────────┘

【接続追加/編集ダイアログ】
┌─────────────────────────────────────────┐
│ データベース接続設定                     │
├─────────────────────────────────────────┤
│ 接続名: [開発DB___________]             │
│ 種類: [MySQL ▼] [PostgreSQL]            │
│ ホスト: [localhost________]             │
│ ポート: [3306_____________]             │
│ データベース: [myapp_dev_______]         │
│ ユーザー名: [root__________]             │
│ パスワード: [**************]             │
│ SSL: [ ] 有効                           │
│                                         │
│ [接続テスト] [保存] [キャンセル]         │
└─────────────────────────────────────────┘

【結果保存ダイアログ】
┌─────────────────────────────────────────┐
│ 結果を保存                               │
├─────────────────────────────────────────┤
│ 名前: user_list_20251228               │
│ コメント: [アクティブユーザー一覧]      │
│ 形式: [TSV ▼] [JSON]                   │
│ [保存] [キャンセル]                      │
└─────────────────────────────────────────┘
```

## 主要機能

### 🎯 主要機能

1. **データベース接続管理**
   - 複数の接続プロファイルを保存
   - MySQL/PostgreSQL両方に対応
   - 接続の追加・編集・削除
   - 接続の切り替え
   - パスワードの安全な保存（Secret Storage）

2. **テーブル定義の自動ドキュメント化**
   - 全テーブルの構造を取得
   - Markdown形式でドキュメント生成
   - プロジェクト内に保存（例: `querycanvas-schema/tables/`）
   - Cursorと会話しながらドキュメント改善

3. **クエリ結果の保存と管理**
   - TSV/JSON形式でエクスポート
   - 名前とコメントを付けて管理
   - タイムスタンプ付きで保存
   - プロジェクト内に保存（例: `db-data/`）
   - 後で分析・比較に使用可能

4. **保存データの一覧と再利用**
   - 過去に保存したデータの一覧表示
   - メタデータ（名前、コメント、日時）の表示
   - 保存したデータをCursorで分析

## 詳細機能要件

### 1. データベース接続管理（重要機能）

#### 接続プロファイルの管理

- **複数接続の保存**
  - 開発環境、ステージング、本番など複数の接続を管理
  - 接続ごとに名前を付けて識別（例: 「開発DB」「本番DB（読み取り専用）」）
  - 接続の追加・編集・削除

- **接続情報の項目**
  - **接続名**: わかりやすい名前（例: 開発DB）
  - **データベース種類**: MySQL / PostgreSQL
  - **ホスト**: localhost, 192.168.1.100, db.example.com など
  - **ポート**: 
    - MySQL: デフォルト 3306
    - PostgreSQL: デフォルト 5432
  - **データベース名**: 接続先のデータベース
  - **ユーザー名**: データベースユーザー
  - **パスワード**: ユーザーのパスワード
  - **SSL有効化**: （オプション）SSL接続の有効/無効

- **接続情報の保存場所**
  ```
  .vscode/querycanvas-connections.json (パスワード以外)
  Secret Storage (パスワードのみ)
  ```

- **querycanvas-connections.json の例**
  ```json
  {
    "connections": [
      {
        "id": "dev-mysql",
        "name": "開発DB",
        "type": "mysql",
        "host": "localhost",
        "port": 3306,
        "database": "myapp_development",
        "username": "devuser",
        "ssl": false
      },
      {
        "id": "prod-postgres",
        "name": "本番DB（読み取り専用）",
        "type": "postgresql",
        "host": "db.example.com",
        "port": 5432,
        "database": "myapp_production",
        "username": "readonly_user",
        "ssl": true
      }
    ],
    "activeConnectionId": "dev-mysql"
  }
  ```

#### 接続操作

- **接続の切り替え**
  - ドロップダウンで接続を選択
  - 選択した接続に自動的に接続

- **接続テスト**
  - 保存前に接続をテスト
  - 成功/失敗のフィードバック

- **接続状態の表示**
  - 接続中: ●（緑）「開発DB に接続中」
  - 切断中: ○（灰）「未接続」
  - エラー: ✕（赤）「接続エラー: ...」

- **自動再接続**
  - 接続が切れた場合の自動再接続（オプション）

#### セキュリティ

- ⚠️ **パスワードの安全な保存**
  - パスワードは **Secret Storage API** に保存
  - `querycanvas-connections.json` にはパスワードを含めない
  - キー: `vsex001.db.password.{connectionId}`

- ⚠️ **パブリックリポジトリへの配慮**
  - `.vscode/querycanvas-connections.json` を `.gitignore` に追加
  - サンプルファイル `db-connections.sample.json` を提供

### 2. SQLクエリ実行

- **SQL入力**
  - 複数行のテキストエリア
  - シンタックスハイライト（可能であれば）
  - 実行ボタン

- **クエリ実行**
  - SELECT: 結果をテーブル表示
  - INSERT/UPDATE/DELETE: 影響行数を表示
  - エラー時はエラーメッセージを表示

- **実行履歴**
  - 過去に実行したクエリの履歴（オプション機能）

### 3. 結果表示

- **テーブル表示**
  - 列名のヘッダー
  - データ行
  - NULL値の表示（例: `<NULL>`）
  - 大量データの場合はページネーション（オプション）

- **メタ情報**
  - 実行時間
  - 取得行数
  - 影響を受けた行数（INSERT/UPDATE/DELETE）

### 4. テーブル定義取得（Cursor連携）

- **全テーブル一覧取得**
  - データベース内の全テーブルを取得
  - テーブルごとにファイル生成

- **テーブル構造の詳細取得**
  - カラム名、データ型、NULL可否
  - PRIMARY KEY、FOREIGN KEY
  - インデックス情報
  - デフォルト値
  - コメント（あれば）

- **Markdown形式でドキュメント生成**
  ```markdown
  # users テーブル
  
  ## 概要
  ユーザー情報を管理するテーブル
  
  ## カラム定義
  | カラム名 | 型 | NULL | キー | デフォルト | 説明 |
  |---------|-----|------|------|-----------|------|
  | id | INT | NO | PRI | NULL | ユーザーID |
  | name | VARCHAR(100) | NO | | NULL | ユーザー名 |
  | email | VARCHAR(255) | NO | UNI | NULL | メールアドレス |
  | created_at | TIMESTAMP | NO | | CURRENT_TIMESTAMP | 作成日時 |
  
  ## インデックス
  - PRIMARY: id
  - UNIQUE: email
  
  ## 外部キー制約
  （なし）
  
  ## メモ
  （Cursorと会話しながら追記）
  ```

- **保存先**
  - `querycanvas-schema/tables/users.md`
  - `querycanvas-schema/tables/orders.md`
  - `querycanvas-schema/README.md` （データベース全体の概要）

### 5. クエリ結果の保存（Cursor連携）

- **保存形式**
  - **TSV**: タブ区切り形式（Excelで開きやすい）
  - **JSON**: プログラムで処理しやすい

- **メタデータ付き保存**
  - **名前**: `user_list_20251228`
  - **コメント**: `アクティブユーザー一覧 - 12月分析用`
  - **実行SQL**: 実行したクエリ
  - **実行日時**: `2025-12-28 14:30:00`
  - **行数**: `150`

- **保存先構造**
  ```
  db-data/
  ├── metadata.json          # すべての保存データのメタデータ
  ├── user_list_20251228.tsv
  ├── user_list_20251228.json
  ├── order_summary_q4.tsv
  └── order_summary_q4.json
  ```

- **metadata.json の例**
  ```json
  {
    "datasets": [
      {
        "id": "user_list_20251228",
        "name": "ユーザー一覧（12月）",
        "comment": "アクティブユーザー一覧 - 12月分析用",
        "sql": "SELECT * FROM users WHERE status = 'active'",
        "executedAt": "2025-12-28T14:30:00Z",
        "rowCount": 150,
        "formats": ["tsv", "json"]
      }
    ]
  }
  ```

### 6. データ管理機能

- **保存データ一覧表示**
  - 名前、コメント、日時を一覧表示
  - クリックでファイルを開く

- **保存データの削除**
  - 不要なデータセットを削除

- **Cursorでの活用**
  - 保存したデータについてCursorと会話
  - 「db-data/user_list_20251228.tsv のデータを分析して」
  - 複数データセットの比較分析

## 非機能要件

### セキュリティ

- ⚠️ **重要**: パスワードをプレーンテキストで保存しない
- VS Code Secret Storage API を使用
- パブリックリポジトリに接続情報を含めない

### パフォーマンス

- 大量の結果セット（10,000行以上）の処理
- 長時間実行されるクエリのタイムアウト設定

### エラーハンドリング

- 接続エラーの適切な表示
- SQL構文エラーの表示
- ネットワークエラーの処理

## 技術設計

### 使用ライブラリ

- **mysql2**: Node.js用のMySQLクライアント
  ```bash
  npm install mysql2
  ```

- **pg**: Node.js用のPostgreSQLクライアント
  ```bash
  npm install pg
  npm install @types/pg --save-dev
  ```

### アーキテクチャ

```
┌─────────────────────────────────────────┐
│ Webview UI (HTML/CSS/JavaScript)       │
│ - SQL入力エリア                         │
│ - 結果テーブル表示                      │
│ - テーブル定義取得ボタン                │
│ - 結果保存ダイアログ                    │
└──────────────┬──────────────────────────┘
               │ postMessage
               ↓
┌─────────────────────────────────────────┐
│ Extension (TypeScript)                  │
│ - メッセージハンドラー                  │
│ - 接続プロファイル管理                  │
│ - データベース接続管理（抽象化）        │
│ - クエリ実行                            │
│ - スキーマ取得                          │
│ - ファイル保存（TSV/JSON/Markdown）     │
│ - メタデータ管理                        │
└──────────┬─────────┬────────────────────┘
           │         │
     mysql2│         │pg (PostgreSQL)
           ↓         ↓
┌──────────────┐ ┌──────────────┐
│ MySQL DB     │ │PostgreSQL DB │
└──────────────┘ └──────────────┘
               ↓
┌─────────────────────────────────────────┐
│ ワークスペース内のファイル              │
│ querycanvas-schema/          テーブル定義.md     │
│ db-data/            クエリ結果.tsv/json │
└─────────────────────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│ Cursor AI                               │
│ - スキーマドキュメントを読む            │
│ - 保存データを分析                      │
│ - ドキュメント改善提案                  │
└─────────────────────────────────────────┘
```

### コンポーネント設計

#### 接続管理レイヤー
1. **ConnectionProfileManager** - 接続プロファイルの管理（CRUD）
2. **IDBConnection** (インターフェース) - データベース接続の抽象化
3. **MySQLConnection** - MySQL接続の実装
4. **PostgreSQLConnection** - PostgreSQL接続の実装
5. **ConnectionFactory** - 接続タイプに応じた接続インスタンス生成

#### ビジネスロジックレイヤー
6. **QueryExecutor** - クエリ実行
7. **SchemaExtractor** - テーブル定義取得・ドキュメント生成
8. **DatasetManager** - クエリ結果の保存・管理
9. **ResultFormatter** - 結果の整形
10. **FileWriter** - TSV/JSON/Markdownファイル書き込み
11. **MetadataManager** - メタデータ管理（metadata.json）

#### UIレイヤー
12. **WebviewProvider** - Webviewの管理
13. **UIMessageHandler** - UIからのメッセージハンドリング

## 実装手順

### フェーズ1: 基本機能
1. ✅ プロジェクト基本構造の作成（完了）
2. ⏳ 依存関係の追加（mysql2, pg）
3. ⏳ データベース接続の抽象化（インターフェース設計）
4. ⏳ 接続プロファイル管理機能
5. ⏳ 接続追加/編集/削除UI
6. ⏳ MySQL接続の実装
7. ⏳ PostgreSQL接続の実装
8. ⏳ Webviewパネルの作成
9. ⏳ SQL実行機能の実装
10. ⏳ 結果表示UIの実装

### フェーズ2: Cursor連携機能
8. ⏳ テーブル定義取得機能
9. ⏳ Markdownドキュメント生成（querycanvas-schema/）
10. ⏳ クエリ結果保存機能（TSV/JSON）
11. ⏳ メタデータ管理（metadata.json）
12. ⏳ データ一覧表示UI
13. ⏳ ファイル管理機能（削除など）

### フェーズ3: 改善・最適化
14. ⏳ エラーハンドリングの強化
15. ⏳ UIの改善
16. ⏳ テスト・デバッグ
17. ⏳ ドキュメント整備

## セキュリティ上の注意

### パブリックリポジトリでの注意点

- ❌ 実際の接続情報をコードに含めない
- ❌ サンプルに実在のホスト名/ユーザー名を使わない
- ✅ `.env` ファイルを使う場合は `.gitignore` に追加
- ✅ README に「接続情報は自己責任で管理」と明記

## 使用例

### 接続設定例

**MySQL接続**
```
接続名: 開発DB
種類: MySQL
ホスト: localhost
ポート: 3306
ユーザー: root
パスワード: ********
データベース: myapp_development
SSL: 無効
```

**PostgreSQL接続**
```
接続名: 本番DB（読み取り専用）
種類: PostgreSQL
ホスト: db.example.com
ポート: 5432
ユーザー: readonly_user
パスワード: ********
データベース: myapp_production
SSL: 有効
```

### クエリ例

```sql
-- ユーザー一覧取得
SELECT * FROM users LIMIT 10;

-- 新規レコード挿入
INSERT INTO users (name, email) VALUES ('Test User', 'test@example.com');

-- 更新
UPDATE users SET name = 'Updated Name' WHERE id = 1;
```

## Cursor連携の具体的なユースケース

### 1. 複数環境のデータベース管理

```
開発者: 「接続管理」で複数のDB接続を登録
        - 開発DB (MySQL)
        - ステージングDB (PostgreSQL)
        - 本番DB（読み取り専用）(MySQL)
開発者: ドロップダウンで「開発DB」を選択 → 自動接続
開発者: クエリ実行後、「本番DB」に切り替えて同じクエリを実行
開発者: 両方の結果を保存して比較
```

### 2. データベーススキーマのドキュメント化

```
開発者: 「テーブル定義を取得」ボタンをクリック
拡張機能: querycanvas-schema/ にMarkdownファイルを生成
開発者: Cursorに「users テーブルの設計を確認して、改善点を提案して」
Cursor: querycanvas-schema/tables/users.md を読んで提案
開発者: ドキュメントに改善内容を追記
```

### 3. データ分析のワークフロー

```
開発者: SQLで月別売上データを取得
開発者: 「結果を保存」→ 名前「monthly_sales_2025」、形式「TSV」
拡張機能: db-data/monthly_sales_2025.tsv を保存
開発者: Cursorに「monthly_sales_2025.tsv を分析して、トレンドを教えて」
Cursor: データを読んで分析結果を提示
```

### 4. データセットの比較分析

```
開発者: 12月のユーザーデータを user_list_dec.tsv として保存
開発者: 翌月、1月のデータを user_list_jan.tsv として保存
開発者: Cursorに「user_list_dec.tsv と user_list_jan.tsv を比較して」
Cursor: 増減や変化を分析
```

## 今後の拡張案

- [ ] 複数データベース接続の管理
- [ ] クエリ履歴機能
- [ ] お気に入りクエリの保存
- [ ] オートコンプリート（テーブル名・カラム名）
- [ ] ER図の自動生成
- [ ] テーブル間のリレーション可視化
- [ ] データセットの差分表示
- [ ] PostgreSQL、SQLiteなど他のデータベース対応

## 参考リンク

- [VS Code Webview API](https://code.visualstudio.com/api/extension-guides/webview)
- [mysql2 Documentation](https://github.com/sidorares/node-mysql2)
- [VS Code Secret Storage API](https://code.visualstudio.com/api/references/vscode-api#SecretStorage)

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|----------|--------|
| 2025-12-28 | 初版作成 | okuyama |

